files:
  "/etc/ssl/certs/cross-stitch.crt":
    mode: "000644"
    owner: root
    group: root
    content: |
      -----BEGIN CERTIFICATE-----
      [Paste contents of certificate from cross-stitch-cert.json]
      -----END CERTIFICATE-----
  "/etc/ssl/private/cross-stitch.key":
    mode: "000600"
    owner: root
    group: root
    content: |
      -----BEGIN PRIVATE KEY-----
      [Paste contents of private key from cross-stitch-cert.json]
      -----END PRIVATE KEY-----
  "/etc/ssl/certs/cross-stitch-chain.crt":
    mode: "000644"
    owner: root
    group: root
    content: |
      -----BEGIN CERTIFICATE-----
      [Paste contents of certificate chain from cross-stitch-cert.json]
      -----END CERTIFICATE-----
  "/etc/nginx/conf.d/ssl.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 443 ssl;
          server_name cross-stitch.design www.cross-stitch.design;
          ssl_certificate /etc/ssl/certs/cross-stitch.crt;
          ssl_certificate_key /etc/ssl/private/cross-stitch.key;
          ssl_trusted_certificate /etc/ssl/certs/cross-stitch-chain.crt;
          location / {
              proxy_pass http://127.0.0.1:80;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }
      server {
          listen 80;
          server_name cross-stitch.design www.cross-stitch.design;
          return 301 https://$host$request_uri;
      }
Resources:
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - config: configure_instance
        configure_instance:
          commands:
            01_restart_nginx:
              command: systemctl restart nginx